<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FINQ ‚Ä¢ Sign Up</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 45%, #d1c4e9 100%);
      overflow-x: hidden;
    }
    .auth-flex {
      display: flex;
      gap: 36px;
      background: rgba(255, 255, 255, 0.13);
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.11);
      border-radius: 36px;
      padding: 45px 35px;
      backdrop-filter: blur(24px);
      max-width: 900px;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
    }
    .form-card,
    .slider-card {
      border-radius: 24px;
      box-shadow: 0 4px 32px #1976d245;
      background: rgba(255, 255, 255, 0.28);
      display: flex;
      flex-direction: column;
      min-width: 340px;
      padding: 40px 32px;
      flex: 1 1 0;
      justify-content: center;
    }
    .form-card h2 {
      font-size: 2.1rem;
      margin-bottom: 8px;
      letter-spacing: -1px;
      text-align: center;
      color: #184089;
    }
    .form-card p {
      margin: 0 0 20px 0;
      text-align: center;
    }
    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .form-grid input[type='email'],
    .form-grid input[type='password'] {
      padding: 11px;
      font-size: 1rem;
      border-radius: 13px;
      border: 1.7px solid #90caf9;
      background: rgba(255, 255, 255, 0.33);
      outline: none;
    }
    .form-grid input:focus {
      border: 2px solid #1976d2;
    }
    .pwrow {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pwrow input {
      flex: 1;
    }
    .pwrow .toggle {
      background: none;
      border: none;
      margin-left: -32px;
      cursor: pointer;
      font-size: 1.05em;
      user-select: none;
    }
    .form-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .primary-btn {
      position: relative;
      overflow: hidden;
      padding: 13px 0;
      background: linear-gradient(90deg, #1976d2 20%, #42a5f5 80%);
      color: #fff;
      font-size: 1rem;
      border: none;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 19px rgba(25, 118, 210, 0.9);
      transition: filter 0.3s ease;
      outline: none;
    }
    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .primary-btn:focus-visible {
      outline: 3px solid #4cb3ff;
      outline-offset: 3px;
    }
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255 255 255 / 0.5);
      transform: scale(0);
      animation: ripple-effect 600ms linear;
      pointer-events: none;
    }
    @keyframes ripple-effect {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    .or-sep {
      text-align: center;
      color: #7c8ca2;
      font-size: 0.98rem;
      margin: 8px 0;
      user-select: none;
    }
    .oauth-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 13px;
      padding: 12px;
      font-size: 1rem;
      border: none;
      border-radius: 15px;
      background: #fff;
      box-shadow: 0 1.5px 8px rgba(25, 118, 210, 0.2);
      color: #26315b;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
      transition: box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
      outline: none;
    }
    .oauth-btn:hover {
      box-shadow: 0 0 20px rgba(17, 67, 157, 0.8);
    }
    .oauth-btn img {
      height: 21px;
      user-select: none;
    }
    .footer-links {
      margin-top: 13px;
      text-align: center;
      font-size: 0.95em;
      user-select: none;
    }
    .footer-links a {
      color: #2464e2;
      text-decoration: none;
      font-weight: 600;
    }
    .footer-links a:hover,
    .footer-links a:focus {
      text-decoration: underline;
    }
    .g-recaptcha {
      margin: 10px 0;
      align-self: center;
    }
    .error-msg {
      color: #e53935;
      text-align: center;
      min-height: 26px;
      font-size: 0.97em;
      user-select: text;
      white-space: pre-wrap;
    }
    .slider-card {
      flex: 1.1 1 0;
      justify-content: center;
      align-items: center;
      min-width: 320px;
      min-height: 330px;
      background: rgba(242, 245, 255, 0.46);
    }
    .slider-img {
      width: 88%;
      height: 250px;
      object-fit: cover;
      border-radius: 19px;
      box-shadow: 0 3px 21px #98bffa49;
      transition: opacity 0.6s;
    }
    .slider-caption {
      font-weight: 600;
      color: #264084;
      font-size: 1rem;
      text-align: center;
      margin-top: 18px;
      letter-spacing: 0.04em;
    }
    @media (max-width: 900px) {
      .auth-flex {
        flex-direction: column;
        gap: 22px;
        padding: 0 10px;
      }
      .form-card,
      .slider-card {
        min-width: 220px;
        width: 100%;
      }
      .slider-img {
        height: 155px;
      }
    }
    .pagefade {
      animation: fadein 0.48s;
    }
    @keyframes fadein {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="auth-flex pagefade">
    <!-- FORM -->
    <form class="form-card" id="signupForm" autocomplete="on" tabindex="1" novalidate>
      <h2>Sign Up to FINQ</h2>
      <p>
        Already have an account? <a href="login.html" class="footer-links">Login here</a>
      </p>
      <div class="form-grid" id="emailStage">
        <input
          required
          type="email"
          placeholder="E-mail address"
          autocomplete="username"
          id="semail"
        />
        <button type="button" id="requestOtpBtn" disabled>Request OTP</button>
      </div>
      <div class="form-grid hidden" id="otpStage">
        <input
          required
          maxlength="6"
          pattern="[0-9]{6}"
          autofocus
          placeholder="Enter OTP"
          id="sotp"
        />
        <button type="button" id="verifyOtpBtn" disabled>Verify OTP</button>
      </div>
      <div class="form-grid hidden" id="passwordStage">
        <div class="pwrow">
          <input
            required
            type="password"
            placeholder="Password"
            autocomplete="new-password"
            id="spass"
            minlength="6"
          />
          <button type="button" class="toggle" tabindex="-1" onclick="togglePw('spass', this)">üëÅÔ∏è</button>
        </div>
        <div class="pwrow">
          <input
            required
            type="password"
            placeholder="Confirm Password"
            id="spass2"
            minlength="6"
          />
          <button type="button" class="toggle" tabindex="-1" onclick="togglePw('spass2', this)">üëÅÔ∏è</button>
        </div>
      </div>
      <div class="g-recaptcha" data-sitekey="6LeN77grAAAAAEtlkWFhwBVLOaNuqLjGgO1JAWlu"></div>
      <div class="form-actions" id="finalActions" hidden>
        <button class="primary-btn" type="submit" id="signBtn" disabled>Sign Up to FINQ</button>
        <div class="or-sep">or continue with</div>
        <button class="oauth-btn" type="button" id="googleSign">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" />
          Google
        </button>
        <button class="oauth-btn" type="button" id="appleSign">
          <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" />
          Apple
        </button>
      </div>
      <div class="error-msg" id="serr"></div>
      <div class="footer-links">
        <a href="help.html">Help</a>
      </div>
    </form>
    <!-- SLIDER -->
    <div class="slider-card">
      <img id="simg" class="slider-img" src="" alt="Family finance" />
      <div id="scap" class="slider-caption">Transparency in Family Finance</div>
    </div>
  </div>

<script>
  // Toggle password visibility
  function togglePw(id, btn) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
    btn.textContent = input.type === "password" ? "üëÅÔ∏è" : "üôà";
  }

  // Elements and variables
  const emailInput = document.getElementById("semail");
  const requestOtpBtn = document.getElementById("requestOtpBtn");
  const otpStage = document.getElementById("otpStage");
  const otpInput = document.getElementById("sotp");
  const verifyOtpBtn = document.getElementById("verifyOtpBtn");
  const passwordStage = document.getElementById("passwordStage");
  const finalActions = document.getElementById("finalActions");
  const signBtn = document.getElementById("signBtn");
  const errorMsg = document.getElementById("serr");

  // Validate email and enable Request OTP
  emailInput.addEventListener("input", () => {
    const validMail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value);
    requestOtpBtn.disabled = !validMail;
    errorMsg.textContent = validMail ? "" : "Enter a valid email address.";
  });

  // Request OTP click handler - calls backend signup API with reCAPTCHA token
  requestOtpBtn.onclick = async () => {
    errorMsg.textContent = "";
    const recaptchaToken = grecaptcha.getResponse();
    if (!recaptchaToken) {
      errorMsg.textContent = "Please complete the CAPTCHA.";
      return;
    }
    requestOtpBtn.disabled = true;

    try {
      const response = await fetch('/api/v1/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: emailInput.value.trim(),
          password: 'dummy', // OTP requested before password, so dummy here
          recaptchaToken,
        }),
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'Signup failed.');

      otpStage.classList.remove("hidden");
      document.getElementById("emailStage").classList.add("hidden");
      otpInput.focus();
    } catch (err) {
      errorMsg.textContent = err.message;
    } finally {
      requestOtpBtn.disabled = false;
      grecaptcha.reset();
    }
  };

  // OTP input validation
  otpInput.addEventListener("input", () => {
    verifyOtpBtn.disabled = otpInput.value.length !== 6 || !/^\d{6}$/.test(otpInput.value);
    errorMsg.textContent = "";
  });

  // Verify OTP click handler - simulate OTP check, then show password stage
  verifyOtpBtn.onclick = () => {
    errorMsg.textContent = "";
    if (otpInput.value === "123456") { // You may integrate real OTP verification backend API here
      otpStage.classList.add("hidden");
      passwordStage.classList.remove("hidden");
      finalActions.hidden = false;
      signBtn.disabled = true;
      document.getElementById("spass").focus();
    } else {
      errorMsg.textContent = "Invalid OTP. Please try again.";
    }
  };

  // Password and Confirm Password validation to enable signup button
  function checkPasswords() {
    const pass = document.getElementById("spass").value;
    const pass2 = document.getElementById("spass2").value;
    signBtn.disabled = !pass || !pass2 || pass.length < 6 || pass !== pass2;
    errorMsg.textContent = (pass && pass2 && pass !== pass2) ? "Passwords do not match." : "";
  }
  document.getElementById("spass").addEventListener("input", checkPasswords);
  document.getElementById("spass2").addEventListener("input", checkPasswords);

  // Signup submit handler
  document.getElementById("signupForm").onsubmit = async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";
    signBtn.disabled = true;

    const email = emailInput.value.trim();
    const password = document.getElementById("spass").value;
    const recaptchaToken = grecaptcha.getResponse();

    if (!recaptchaToken) {
      errorMsg.textContent = "Please complete the CAPTCHA.";
      signBtn.disabled = false;
      return;
    }

    try {
      const response = await fetch('/api/v1/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, recaptchaToken }),
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'Signup failed.');

      errorMsg.style.color = "#184089";
      errorMsg.textContent = "Signup successful! Please check your email to verify your account.";

      requestOtpBtn.disabled = true;
      verifyOtpBtn.disabled = true;
      signBtn.disabled = true;
    } catch (err) {
      errorMsg.style.color = "#e53935";
      errorMsg.textContent = err.message;
      signBtn.disabled = false;
      grecaptcha.reset();
    }
  };

  // Ripple effect on buttons
  function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement("span");
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;
    circle.style.width = circle.style.height = diameter + "px";
    circle.style.left = event.clientX - button.getBoundingClientRect().left - radius + "px";
    circle.style.top = event.clientY - button.getBoundingClientRect().top - radius + "px";
    circle.classList.add("ripple");
    const ripple = button.getElementsByClassName("ripple")[0];
    if (ripple) ripple.remove();
    button.appendChild(circle);
  }
  document.querySelectorAll(".primary-btn, .oauth-btn").forEach(btn => {
    btn.addEventListener("click", createRipple);
  });

  // Google OAuth button redirects for signup
  document.getElementById("googleSign").onclick = () => {
    window.location.href = '/api/v1/auth/google';
  };
  // Apple OAuth placeholder
  document.getElementById("appleSign").onclick = () => alert("Apple signup coming soon!");
</script>
</body>
</html>
